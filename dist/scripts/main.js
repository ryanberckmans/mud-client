function mud_login(){postLogin()}function send_to_mud(e){socket.send(e)}function postLogin(){keyboard_handlers(),document.getElementById("user_input").value="",$("#data_form").fadeIn(500,function(){document.getElementById("user_input").focus()}),$("#c_right").hide(),$("#c_output").css("margin-right","auto"),$(window).blur(function(){document.getElementById("user_input").focus()}),$(window).click(function(){document.getElementById("user_input").focus()})}function user_input_down_arrow(){cmd_history_down.length>0?(cmd_history_up.push(document.getElementById("user_input").value),document.getElementById("user_input").value=cmd_history_down.pop()):document.getElementById("user_input").value=""}function user_input_up_arrow(){cmd_history_up.length>0&&(cmd_history_down.push(document.getElementById("user_input").value),document.getElementById("user_input").value=cmd_history_up.pop())}function keyboard_handlers(){$("#user_input").keydown(function(e){"40"==e.keyCode?(e.preventDefault(),user_input_down_arrow(e)):"38"==e.keyCode&&(e.preventDefault(),user_input_up_arrow(e))})}function set_connected_phudbase(){conn_div.style.background="green",conn_div.innerHTML="<p style='font-size: 1.5em; font-weight: bold; color: #fff;'>CONNECTED</p>"}function set_connected_mud(){m_conn_div.style.background="green",m_conn_div.innerHTML="<p style='font-size: 1.5em; font-weight: bold; color: #fff;'>CONNECTED</p>"}function set_disconnected_mud(){m_conn_div.style.background="red",m_conn_div.innerHTML="<p style='font-size: 1.25em; font-weight: bold; color: #fff;'>DISCONNECTED</p>"}function set_disconnected(){conn_div.style.background="red",conn_div.innerHTML="<p style='font-size: 1.25em; font-weight: bold; color: #fff;'>DISCONNECTED</p>",m_conn_div.style.background="red",m_conn_div.innerHTML="<p style='font-size: 1.25em; font-weight: bold; color: #fff;'>DISCONNECTED</p>"}function echo(e){echoStream.pushRaw(e)}(function(){var e,t,n,r,o,s,u,i;this.renderClearTextLine=function(e){return e.replace(/\x1B\[\d\d?m/g,"")},this.renderDOMLine=function(e,t){var n,r;return r=i.colorSpan(e)+o.parse(s(t),{ansiColorState:e,renderAnsiColor:i}),n="<span class='one_line'><br>"+r+"</span></span>",$.parseHTML(n)[0]},this.AnsiColorState=function(){function e(){this.reset()}return e.prototype.reset=function(){return this.foregroundColor=n,this.backgroundColor=t,this.isBold=r,this.isReset=!0,this.color=u(this.foregroundColor,this.backgroundColor,this.isBold),null},e.prototype.setForegroundColor=function(e){return null!==e&&(this.isReset=!1,this.foregroundColor=e,this.color=u(this.foregroundColor,this.backgroundColor,this.isBold)),this.foregroundColor},e.prototype.setBackgroundColor=function(e){return null!==e&&(this.isReset=!1,this.backgroundColor=e,this.color=u(this.foregroundColor,this.backgroundColor,this.isBold)),this.backgroundColor},e.prototype.setIsBold=function(e){return null!==e&&(this.isReset=!1,this.isBold=e,this.color=u(this.foregroundColor,this.backgroundColor,this.isBold)),this.isBold},e}(),s=function(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},u=function(e,t,n){var r;return r=e+"_"+t+"_bg",n&&(r+="_b"),r},n="white",t="black",r=!1,i={colorSpan:function(e){return"<span class='ansi_color_"+e.color+"'>"},changeColor:function(e){return"</span>"+this.colorSpan(e)},fgColorOn:function(e,t){return t===e.foregroundColor?"":(e.setForegroundColor(t),this.changeColor(e))},bgColorOn:function(e,t){return t===e.backgroundColor?"":(e.setBackgroundColor(t),this.changeColor(e))},boldOn:function(e){return e.isBold?"":(e.setIsBold(!0),this.changeColor(e))},boldOff:function(e){return e.isBold?(e.setIsBold(!1),this.changeColor(e)):""},reset:function(e){return e.isReset?"":(e.reset(),this.changeColor(e))}},e='{\n  state  = options.ansiColorState\n  render = options.renderAnsiColor\n}\n\nstart\n  = special:special start:start { return special + start; }\n  / char:. start:start { return char + start; }\n  / ""\n\nspecial\n  = "[1m"  { return render.boldOn(state); }\n  / "[22m" { return render.boldOff(state); }\n  / "[0m"  { return render.reset(state); }\n  / "[00m" { return render.reset(state); }\n // foreground colors\n  / "[30m" { return render.fgColorOn(state,"black"); }\n  / "[31m" { return render.fgColorOn(state,"red"); }\n  / "[32m" { return render.fgColorOn(state,"green"); }\n  / "[33m" { return render.fgColorOn(state,"yellow"); }\n  / "[34m" { return render.fgColorOn(state,"blue"); }\n  / "[35m" { return render.fgColorOn(state,"magenta"); }\n  / "[36m" { return render.fgColorOn(state,"cyan"); }\n  / "[37m" { return render.fgColorOn(state,"white"); }\n // background colors\n  / "[40m" { return render.bgColorOn(state,"black"); }\n  / "[41m" { return render.bgColorOn(state,"red"); }\n  / "[42m" { return render.bgColorOn(state,"green"); }\n  / "[43m" { return render.bgColorOn(state,"yellow"); }\n  / "[44m" { return render.bgColorOn(state,"blue"); }\n  / "[45m" { return render.bgColorOn(state,"magenta"); }\n  / "[46m" { return render.bgColorOn(state,"cyan"); }\n  / "[47m" { return render.bgColorOn(state,"white"); }',o=PEG.buildParser(e)}).call(this),function(){this.inputGrammar='start\n  = cmd:cmd ";" start:start { return cmd.concat(start); }\n  / cmd\n\ncmd\n  = "/" i:integer text:text { var cmds = []; for(;i>0;i--) cmds.push(text.trimLeft()); return cmds; }\n  / "/call" ws host:token ws port:integer text { mud_client.chat.call( host, port ); return [null]; }\n  / text:text { return [text]; }\n\ninteger\n  = digits:[0-9]+ { return parseInt(digits.join(""), 10); }\n\ntoken\n  = s:[^ 	;]+ { return s.join(""); }\n\nws\n  = whitespace\n\nwhitespace\n  = [ 	]+\n\ntext \n  = s:[^;]* { return s.join(""); }'}.call(this),function(){this.TextStream=function(){function e(){this.pushLineHookFunctions=[],this.childTextStreams=[]}return e.prototype.pushLine=function(e,t){var n,r,o,s,u,i,c,l;for(c=this.pushLineHookFunctions,o=0,u=c.length;u>o;o++)(r=c[o])(e,t);for(l=this.childTextStreams,s=0,i=l.length;i>s;s++)n=l[s],n.pushLine(e,t);return null},e.prototype.onPushLine=function(e){return this.pushLineHookFunctions.push(e),null},e.prototype.offPushLine=function(e){var t;return t=this.pushLineHookFunctions.indexOf(e),t>-1&&this.pushLineHookFunctions.splice(t,1),null},e.prototype.addChild=function(e){return this.childTextStreams.push(e),null},e.prototype.removeChild=function(e){var t;return t=this.childTextStreams.indexOf(e),t>-1&&this.childTextStreams.splice(t,1),null},e}()}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};this.AnsiColorStream=function(e){function n(e){null==e&&(e={}),n.__super__.constructor.apply(this,arguments),this.renderClearTextLine=e.renderClearTextLine,this.renderDOMLine=e.renderDOMLine,this.ansiColorState=e.ansiColorState}return t(n,e),n.prototype.pushRaw=function(e){var t;t=e.split("\n"),t[0].length>0&&this.pushLine(this.renderClearTextLine(t[0]),this.renderDOMLine(this.ansiColorState,t[0]));for(var n=1,r=t.length;r>n;++n)this.pushLine(this.renderClearTextLine(t[n]),this.renderDOMLine(this.ansiColorState,t[n]));return null},n}(TextStream)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};this.EchoStream=function(e){function n(e){null==e&&(e={}),n.__super__.constructor.apply(this,arguments),this.jQuery=e.jQuery}return t(n,e),n.prototype.pushRaw=function(e){var t,n,r;if(n=e.split("\n"),n[n.length-1].length<1&&n.pop(),r=n.length,!(1>r)){t=this.jQuery.parseHTML("<span class='echo_line echo_color'>"+n[0]+"</span>")[0],this.pushLine("",t);for(var o=1;r>o;++o)t=this.jQuery.parseHTML("<span class='echo_line echo_color'><br>"+n[o]+"</span>")[0],this.pushLine("",t);return null}},n}(TextStream)}.call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};this.BufferStream=function(e){function n(e){null==e&&(e={}),n.__super__.constructor.apply(this,arguments),this.outputElement=e.outputElement,this.onPushLine(this.appendToBuffer)}return t(n,e),n.prototype.appendToBuffer=function(e,t){return this.outputElement.appendChild(t),this.outputElement.scrollTop=this.outputElement.scrollHeight,null},n}(TextStream)}.call(this),$(document).ready(function(){var e=function(){$("#interface").height($(window).height()-20),$("#output, #scroller, #right").height($("#interface").height()-50)};e(),$(window).resize(e)});var mud_client={input_grammar:inputGrammar,input_parser:PEG.buildParser(inputGrammar),send:function(e){echo(e.replace(/_hack_newline/g,"")),send_to_mud(e)},process_client_input:function(){var e=document.getElementById("user_input").value;for(cmd_history_down.length>0&&cmd_history_up.push(e);cmd_history_down.length>1;)cmd_history_up.push(cmd_history_down.pop());cmd_history_down.pop(),e.length>0&&cmd_history_up.push(e);var t=null;try{t=this.input_parser.parse(e)}catch(n){alert("error parsing:"+e),t=[]}for(var r=0;r<t.length;r++)null==t[r]?(t.splice(r,1),r--):(""==t[r]&&(t[r]="_hack_newline"),t[r]+="\n");return t.length>0&&this.send(t.join("")),document.getElementById("user_input").value="",!0}},socket,conn_div,m_conn_div,next_del,stopped,logging=!1,output_mouse_over=!1,smooth_scroll=!1,h_pct,h_raw,m_pct,m_raw,e_pct,e_raw,w_pct,w_raw,nl_pct,nl_raw,m_nw,m_n,m_ne,m_e,m_se,m_s,m_sw,m_w,m_up,m_down,m_in,m_out,map,mudhost,mudport,scrollback,prevent_autoscroll=!1;fromMudAnsiColorStream=new AnsiColorStream({renderClearTextLine:renderClearTextLine,renderDOMLine:renderDOMLine,ansiColorState:new AnsiColorState}),$(document).ready(function(){conn_div=document.getElementById("connection_ws"),m_conn_div=document.getElementById("connection_mud"),m_nw=document.getElementById("m_nw"),m_n=document.getElementById("m_n"),m_ne=document.getElementById("m_ne"),m_e=document.getElementById("m_e"),m_se=document.getElementById("m_se"),m_s=document.getElementById("m_s"),m_sw=document.getElementById("m_sw"),m_w=document.getElementById("m_w"),m_up=document.getElementById("m_u"),m_down=document.getElementById("m_d"),m_in=document.getElementById("m_i"),m_out=document.getElementById("m_o"),h_pct=document.getElementById("h_pct"),h_raw=document.getElementById("h_raw"),m_pct=document.getElementById("m_pct"),m_raw=document.getElementById("m_raw"),e_pct=document.getElementById("e_pct"),e_raw=document.getElementById("e_raw"),w_pct=document.getElementById("w_pct"),w_raw=document.getElementById("w_raw"),nl_pct=document.getElementById("nl_pct"),nl_raw=document.getElementById("nl_raw"),next_del=0,mode="websocket",socket=new WebSocket(wshost),socket.onopen=function(){set_connected_phudbase(),mud_login()},socket.onmessage=function(e){fromMudAnsiColorStream.pushRaw(e.data)},socket.onclose=function(){echo("<p>Refresh page to reconnect \\o/</p>"),set_disconnected()},socket.onerror=function(e){echo("<p>WebSocket error: "+e.data+"</p>")}});var cmd_history_down=[],cmd_history_up=[],outputElement=window.top.document.getElementById("output"),mainBuffer=new BufferStream({outputElement:outputElement});fromMudAnsiColorStream.addChild(mainBuffer);var echoStream=new EchoStream({jQuery:$});echoStream.addChild(mainBuffer),wshost="ws://192.168.1.124:12346";